<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="description" content="">
<meta name="keywords" content=" ">
<title>XCDL templates preprocessor syntax proposal (outdated) | The xPack Build Framework (DEPRECATED)</title>
<link rel="stylesheet" href="https://xpack.github.io/css/syntax.css">


<link type="application/atom+xml" rel="alternate" href="https://xpack.github.io/feed.xml"/>
<link type="application/rss+xml" rel="alternate" title="web-archive-jekyll" href="https://xpack.github.io/feed.xml">

<!-- Begin Jekyll SEO tag v2.8.0 -->
<title>XCDL templates preprocessor syntax proposal (outdated) | web-archive-jekyll</title>
<meta name="generator" content="Jekyll v3.9.3" />
<meta property="og:title" content="XCDL templates preprocessor syntax proposal (outdated)" />
<meta name="author" content="Liviu Ionescu" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Tools to manage, configure and build complex, package based, multi-target, C/C++ projects." />
<meta property="og:description" content="Tools to manage, configure and build complex, package based, multi-target, C/C++ projects." />
<link rel="canonical" href="https://xpack.github.io/xcdl/work/preprocessor/" />
<meta property="og:url" content="https://xpack.github.io/xcdl/work/preprocessor/" />
<meta property="og:site_name" content="web-archive-jekyll" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2015-10-25T10:00:00+00:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="XCDL templates preprocessor syntax proposal (outdated)" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Liviu Ionescu"},"dateModified":"2024-12-20T19:13:52+00:00","datePublished":"2015-10-25T10:00:00+00:00","description":"Tools to manage, configure and build complex, package based, multi-target, C/C++ projects.","headline":"XCDL templates preprocessor syntax proposal (outdated)","mainEntityOfPage":{"@type":"WebPage","@id":"https://xpack.github.io/xcdl/work/preprocessor/"},"url":"https://xpack.github.io/xcdl/work/preprocessor/"}</script>
<!-- End Jekyll SEO tag -->


<link rel="stylesheet" type="text/css" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
<link rel="stylesheet" href="https://xpack.github.io/css/modern-business.css?202412202113">
<!-- Latest compiled and minified CSS -->
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
<link rel="stylesheet" href="https://xpack.github.io/css/customstyles.css?202412202113">
<link rel="stylesheet" href="https://xpack.github.io/css/boxshadowproperties.css?202412202113">
<!-- most color styles are extracted out to here -->
<link rel="stylesheet" href="https://xpack.github.io/css/theme-blue.css?202412202113">

<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-cookie/1.4.1/jquery.cookie.min.js"></script>
<script src="https://xpack.github.io/js/jquery.navgoco.min.js"></script>


<!-- Latest compiled and minified JavaScript -->
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>
<!-- Anchor.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/anchor-js/4.2.0/anchor.min.js"></script>
<script src="https://xpack.github.io/js/toc.js"></script>
<script src="https://xpack.github.io/js/customscripts.js"></script>

<!-- Use absolute URLs, to cover preview cases too -->
<link rel="shortcut icon" href="https://xpack.github.io/images/favicon/favicon.ico">
<link rel="apple-touch-icon" sizes="57x57" href="https://xpack.github.io/images/favicon/apple-icon-57x57.png">
<link rel="apple-touch-icon" sizes="60x60" href="https://xpack.github.io/images/favicon/apple-icon-60x60.png">
<link rel="apple-touch-icon" sizes="72x72" href="https://xpack.github.io/images/favicon/apple-icon-72x72.png">
<link rel="apple-touch-icon" sizes="76x76" href="https://xpack.github.io/images/favicon/apple-icon-76x76.png">
<link rel="apple-touch-icon" sizes="114x114" href="https://xpack.github.io/images/favicon/apple-icon-114x114.png">
<link rel="apple-touch-icon" sizes="120x120" href="https://xpack.github.io/images/favicon/apple-icon-120x120.png">
<link rel="apple-touch-icon" sizes="144x144" href="https://xpack.github.io/images/favicon/apple-icon-144x144.png">
<link rel="apple-touch-icon" sizes="152x152" href="https://xpack.github.io/images/favicon/apple-icon-152x152.png">
<link rel="apple-touch-icon" sizes="180x180" href="https://xpack.github.io/images/favicon/apple-icon-180x180.png">
<link rel="icon" type="image/png" sizes="192x192"  href="https://xpack.github.io/images/favicon/android-icon-192x192.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://xpack.github.io/images/favicon/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="96x96" href="https://xpack.github.io/images/favicon/favicon-96x96.png">
<link rel="icon" type="image/png" sizes="16x16" href="https://xpack.github.io/images/favicon/favicon-16x16.png">
<link rel="manifest" href="https://xpack.github.io/images/favicon/manifest.json">
<meta name="msapplication-TileColor" content="#ffffff">
<meta name="msapplication-TileImage" content="https://xpack.github.io/images/favicon/ms-icon-144x144.png">
<meta name="theme-color" content="#ffffff">

<!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
<!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
<!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
<script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
<![endif]-->

    <script>
        $(document).ready(function() {
            // Initialize navgoco with default options
            $("#mysidebar").navgoco({
                caretHtml: '',
                accordion: true,
                openClass: 'active', // open
                save: false, // leave false or nav highlighting doesn't work right
                cookie: {
                    name: 'navgoco',
                    expires: false,
                    path: '/'
                },
                slide: {
                    duration: 400,
                    easing: 'swing'
                }
            });

            $("#collapseAll").click(function(e) {
                e.preventDefault();
                $("#mysidebar").navgoco('toggle', false);
            });

            $("#expandAll").click(function(e) {
                e.preventDefault();
                $("#mysidebar").navgoco('toggle', true);
            });

        });

    </script>
    <script>
        $(function () {
            $('[data-toggle="tooltip"]').tooltip()
        })
    </script>
    <script>
        $(document).ready(function() {
            $("#tg-sb-link").click(function() {
                $("#tg-sb-sidebar").toggle();
                $("#tg-sb-content").toggleClass('col-md-9');
                $("#tg-sb-content").toggleClass('col-md-12');
                $("#tg-sb-icon").toggleClass('fa-toggle-on');
                $("#tg-sb-icon").toggleClass('fa-toggle-off');
            });
        });
    </script>
    

</head>
<body>
<!-- Navigation -->
<nav class="navbar navbar-inverse navbar-static-top">
    <div class="container topnavlinks" style="">
        <div style="display: inline-block; float: left; margin-top: 8px; margin-left: auto; margin-right: 10px;"><img src="/images/company_logo.png" alt="logo" width="32px" height="32px"/></div>
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="fa fa-home fa-lg navbar-brand" href="/">&nbsp;<span class="projectTitle"> The xPack Project</span></a>
        </div>
        <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
            <ul class="nav navbar-nav navbar-right">
                <!-- toggle sidebar button -->
                <li><a id="tg-sb-link" href="#"><i id="tg-sb-icon" class="fa fa-toggle-on"></i> Nav</a></li>
                <!-- entries without drop-downs appear here -->




                
                
                
                <!-- entries with drop-downs appear here -->
                <!-- conditional logic to control which topnav appears for the audience defined in the configuration file.-->
                
                
                <li class="dropdown">
                    <a href="#" class="dropdown-toggle" data-toggle="dropdown">News<b class="caret"></b></a>
                    <ul class="dropdown-menu">
                        
                        
                        <li><a href="/news/">Latest News</a></li>
                        
                        
                        
                        <li><a href="/news/archive/">Archive</a></li>
                        
                        
                        
                        <li><a href="/tags/">Tags</a></li>
                        
                        
                    </ul>
                </li>
                
                <li class="dropdown">
                    <a href="#" class="dropdown-toggle" data-toggle="dropdown">Projects<b class="caret"></b></a>
                    <ul class="dropdown-menu">
                        
                        
                        <li><a class="extern" href="https://xpack-dev-tools.github.io" target="_blank" rel="noopener">xPack Binary Development Tools</a></li>
                        
                        
                        
                        <li><a class="extern" href="https://eclipse-embed-cdt.github.io" target="_blank" rel="noopener">Eclipse Embedded CDT</a></li>
                        
                        
                        
                        <li><a class="extern" href="https://micro-os-plus.github.io" target="_blank" rel="noopener">µOS++ IIIe</a></li>
                        
                        
                    </ul>
                </li>
                
                <li class="dropdown">
                    <a href="#" class="dropdown-toggle" data-toggle="dropdown">GitHub<b class="caret"></b></a>
                    <ul class="dropdown-menu">
                        
                        
                        <li><a class="extern" href="https://github.com/xpack/" target="_blank" rel="noopener">xPack</a></li>
                        
                        
                        
                        <li><a class="extern" href="https://github.com/xpack-dev-tools/" target="_blank" rel="noopener">3rd Party xPack Dev Tools</a></li>
                        
                        
                        
                        <li><a class="extern" href="https://github.com/micro-os-plus/" target="_blank" rel="noopener">µOS++ IIIe</a></li>
                        
                        
                        
                        <li><a class="extern" href="https://github.com/xpack-3rd-party/" target="_blank" rel="noopener">3rd Party xPacks</a></li>
                        
                        
                        
                        <li><a class="extern" href="https://github.com/eclipse-embed-cdt/" target="_blank" rel="noopener">Eclipse Embedded CDT</a></li>
                        
                        
                    </ul>
                </li>
                
                
                
                <!--comment out this block if you want to hide search-->
                <li>
                    <!--start search-->
                    <div id="search-demo-container">
                        <input type="text" id="search-input" placeholder="search...">
                        <ul id="results-container"></ul>
                    </div>
                    <script src="/js/jekyll-search.js" type="text/javascript"></script>
                    <script type="text/javascript">
                            SimpleJekyllSearch.init({
                                searchInput: document.getElementById('search-input'),
                                resultsContainer: document.getElementById('results-container'),
                                dataSource: '/search.json',
                                searchResultTemplate: '<li><a href="{url}" title="XCDL templates preprocessor syntax proposal (outdated)">{title}</a></li>',
                    noResultsText: 'No results found.',
                            limit: 10,
                            fuzzy: true,
                    })
                    </script>
                    <!--end search-->
                </li>
            </ul>
        </div>
        </div>
        <!-- /.container -->
</nav>

<!-- Page Content -->
<div class="container">
  <div id="main">
    <!-- Content Row -->
    <div class="row">
        
        
            <!-- Sidebar Column -->
            <div class="col-md-3 sticky" id="tg-sb-sidebar">
                

<ul id="mysidebar" class="nav">
  <li class="sidebarTitle">xcdl </li>
  
  
  
      
  
  <li>
      <a title="Getting Started" href="#">Getting Started</a>
      <ul>
          
          
          
          <li><a title="Overview" href="/xcdl/">Overview</a></li>
          
          
          
          
          
          
          <li><a title="Old home page" href="/xcdl/outdated/">Old home page</a></li>
          
          
          
          
      </ul>
   </li>
     
      
      
      <!-- if you aren't using the accordion, uncomment this block:
         <p class="external">
             <a href="#" id="collapseAll">Collapse All</a> | <a href="#" id="expandAll">Expand All</a>
         </p>
         -->
</ul>

<!-- this highlights the active parent class in the navgoco sidebar.
this is critical so that the parent expands when you're viewing a page.
This must appear below the sidebar code above. Otherwise, if placed
inside customscripts.js, the script runs before the sidebar code runs
and the class never gets inserted.-->
<script>$("li.active").parents('li').toggleClass("active");</script>

            </div>
            
        

        <!-- Content Column -->
        <div class="col-md-9" id="tg-sb-content">
            <div class="post-header">
   <h1 class="post-title-main">XCDL templates preprocessor syntax proposal (outdated)</h1>
</div>



<div class="post-content">

   

    
    
<!-- this handles the automatic toc. use ## for subheads to auto-generate the on-page minitoc. if you use html tags, you must supply an ID for the heading element in order for it to appear in the minitoc. -->
<script>
$( document ).ready(function() {
  // Handler for .ready() called.

$('#toc').toc({ minimumHeaders: 0, listType: 'ul', showSpeed: 0, headers: 'h2,h3' });

/* this offset helps account for the space taken up by the floating toolbar. */
$('#toc').on('click', 'a', function() {
  var target = $(this.getAttribute('href'))
    , scroll_target = target.offset().top

  $(window).scrollTop(scroll_target - 10);
  return false
})

});
</script>

<div id="toc"></div>

    

        


   <h2 id="challenge">Challenge</h2>

<p>Define a template based preprocessing mechanism to be used to generate source files in a wizard (mainly C/C++).</p>

<h2 id="requirements">Requirements</h2>

<ul>
  <li>interfere as little as possible with the native file source language</li>
  <li>do not interfere with other tools, like Doxygen</li>
  <li>be as simple as possible to process</li>
  <li>syntax must be as standard as possible</li>
</ul>

<h2 id="embed-metadata-inside-comments">Embed metadata inside comments</h2>

<p>The natural implementation for the first requirement is similar to that used by Doxygen, i.e. insert the preprocessing metadata as standard comments.</p>

<p>The direct consequence is that the template files are regular source files, they do not introduce a new syntax.</p>

<p>This has two major advantages:</p>

<ul>
  <li>the template files can be edited with current editors, and do not interfere with syntax colouring;</li>
  <li>the template files can be reformatted with existing formatters.</li>
</ul>

<h2 id="inspiration">Inspiration</h2>

<p>Although there are many other similar solutions, none that I know meets the above requirements.</p>

<h3 id="jekyll">Jekyll</h3>

<p>The <a href="https://jekyllrb.com">Jekyll</a> static web generator uses the <a href="https://shopify.github.io/liquid/">Liquid</a> metadata, which comes in two types: tags (for flow control) and object/filters (for inserting content).</p>

<pre><code class="language-txt">{% if user %}
  hello("{{ user.name }}!");
{% endif %}
  url="{{ url | append: ".html" }}";
</code></pre>

<p>Embedding this metadata into C/C++ comments would look like this:</p>

<pre><code class="language-txt">//@XCDL {% if user %}
  hello("{{ user.name }}!");
//@XCDL {% endif %}
  url="{{ url | append: ".html" }}";
</code></pre>

<p>The syntax remains relatively easy to read, but the Liquid tags still introduce a new language, that needs to be parsed and processed.</p>

<h3 id="jinja2">Jinja2</h3>

<p>The default syntax of <a href="https://jinja.pocoo.org/docs/dev/">Jinja2</a> matches Django syntax in many ways, and it also very similar to the syntax of <a href="https://shopify.github.io/liquid/">Liquid</a> metadata, so it will not be repeated here.</p>

<h3 id="st-cubemx">ST CubeMX</h3>

<p>CubeMX uses <code class="language-plaintext highlighter-rouge">.ftl</code> files with a complex script syntax, somehow inspired by xml; tags may come in pairs (<code class="language-plaintext highlighter-rouge">[if]</code>, <code class="language-plaintext highlighter-rouge">[/if]</code>), and substitutions are encoded like macros (<code class="language-plaintext highlighter-rouge">${argument.name}</code>).</p>

<pre><code class="language-txt">[#ftl]
[#-- macro generateConfigModelCode --]

[#macro generateConfigModelCode configModel inst nTab index]
[#if configModel.methods??] [#-- if the pin configuration contains a list of LibMethods--]
    [#assign methodList = configModel.methods]
[#else]
    [#if configModel.methods??]
        [#assign methodList = configModel.libMethod]
    [/#if]
[/#if]
[#assign writeConfigComments=false]
[#if methodList?? ]
[#list methodList as method]
    [#if method.status=="OK"][#assign writeConfigComments=true][/#if]
[/#list]
[#if writeConfigComments]
[#if configModel.comments??] #t#t/**${configModel.comments?replace("#t","#t#t")} #n#t#t*/[/#if]
[/#if]
... ${argument.name} ...
</code></pre>

<p>The syntax controls the details of the expansion to the latest details, including generating tabs and new lines (<code class="language-plaintext highlighter-rouge">#t</code>, <code class="language-plaintext highlighter-rouge">#n</code>), so the template s are not really source files, and embedding the metadata as comments doesn’t make much sense.</p>

<p>(The files are in the <code class="language-plaintext highlighter-rouge">db/templates</code> folder; on macOS this is located below <code class="language-plaintext highlighter-rouge">STM32CubeMX.app/Contents/Resources</code>).</p>

<h3 id="infineon-dave">Infineon DAVE</h3>

<p>In DAVE 4 templates are stored as <code class="language-plaintext highlighter-rouge">.tmpl</code> files and use full <a href="https://www.groovy-lang.org">Groovy</a> scripts (which look very familiar to Java programmers).</p>

<pre><code class="language-.java">package Model.Common;

out.print("""
/*******************************************************************************
 Copyright (c) 2014, Infineon Technologies AG                                 **
 All rights reserved.                                                         **
*******************************************************************************/

/*******************************************************************************
 * @brief This function initializes the Apps Init Functions.
 *
 * @param[in]  None
 *
 * @return  DAVE_STATUS_t &lt;BR&gt;
 *
 * &lt;b&gt;Reentrant: No &lt;/b&gt;&lt;BR&gt;
 *
 ******************************************************************************/

DAVE_STATUS_t DAVE_Init(void)
{
  DAVE_STATUS_t init_status;

  init_status = DAVE_STATUS_SUCCESS;

 """);

def appsList = daveEnv.project.getTopLevelApps();
def apps = [];
def appName
def instanceLabel

 for (def app : appsList ) {
    if(app.initProvider) {
      apps.add(app);
    }
 }
out.print("""

/** @Initialization of Apps Init Functions */

""");
 for (def app : apps ) {
   appName = app.getClass().getSimpleName()
   instanceLabel = app.getInstanceLabel()
out.print("""
  if (init_status == DAVE_STATUS_SUCCESS)
  {
    /**  Initialization of ${appName} App instance ${instanceLabel} */
    init_status = (DAVE_STATUS_t)${appName}_Init(&amp;${instanceLabel});
  }
""");

}
out.print("""

  return init_status;
} /**  End of function DAVE_Init */
""");
</code></pre>

<p>The actual content is included with triple quote strings and substitutions are performed on the way, using the <code class="language-plaintext highlighter-rouge">${appName}</code> syntax.</p>

<p>By using a fully fledged script language, the template engine is very powerful.</p>

<p>However, embedding the C/C++ code as strings in Groovy is quite hard to read.</p>

<p>Templates can be found in <code class="language-plaintext highlighter-rouge">Infineon\D_LibraryStore_4.1\DeviceFeatures\pack\2.0.0\CE_Templates\TLE</code></p>

<h3 id="freescale-processor-expert">Freescale Processor Expert</h3>

<p>The late Processor Expert is probably the grand-dad of all component code-generating solutions. It was designed as the ultimate solution, and indeed it provides lots of features, but at the cost of a very high complexity. (for an overview, please read this <a href="https://mcuoneclipse.com/2015/10/18/overview-processor-expert/">article</a>).</p>

<p>There are many XML file with lots of definitions.</p>

<p>The templates are <code class="language-plaintext highlighter-rouge">.drv</code> files, and the syntax looks like:</p>

<pre><code class="language-txt">%-
%INTERFACE
%define! Settings Common\FAT_FileSystemSettings.Inc
%define! Abstract Common\FAT_FileSystemAbstract.Inc
%include Common\Header.h

#ifndef __%'ModuleName'_H
#define __%'ModuleName'_H

/* MODULE %ModuleName. */
/* Wrappers to FatFS types and constants */
#define %'ModuleName'%.FATFS            FATFS
#define %'ModuleName'%.DIR              DIR
#define %'ModuleName'%.FIL              FIL
#define %'ModuleName'%.FILINFO          FILINFO
#define %'ModuleName'%.FS_READONLY      _FS_READONLY
#define %'ModuleName'%.USE_LFN          _USE_LFN
#define %'ModuleName'%.MAX_LFN          _MAX_LFN
#define %'ModuleName'%.FS_REENTRANT     _FS_REENTRANT
#define %'ModuleName'%.MAX_SS           _MAX_SS
#define %'ModuleName'%.FS_RPATH         _FS_RPATH
#define %'ModuleName'%.FRESULT          FRESULT
#define %'ModuleName'%.DRESULT          DRESULT

%ifdef SharedModules
/* Include shared modules, which are used for whole project */
  %for var from IncludeSharedModules
#include "%'var'.h"
  %endfor
%endif
/* Include inherited beans */
%ifdef InhrSymbolList
  %for var from InhrSymbolList
#include "%@%var@ModuleName.h"
  %endfor
%endif
...
%-************************************************************************************************************
%-BW_METHOD_BEGIN RenameFile
%ifdef RenameFile
%define! ParsrcFileName
%define! PardstFileName
%define! Pario
%define! RetVal
%include Common\FAT_FileSystemRenameFile.Inc
/*!
 * \brief Renames a file
 * \param[in] srcFileName Source/existing file name
 * \param[in] dstFileName Destination/new file name
 * \param[in] io IO handler for output
 * \return Error code, ERR_OK for success.
 */
uint8_t %'ModuleName'%.%RenameFile(const uint8_t *srcFileName, const uint8_t *dstFileName, const %@Shell@'ModuleName'%.StdIOType *io)
{
  %'ModuleName'%.FRESULT fres;

  if (%'ModuleName'%.isWriteProtected((uint8_t*)"")) {
    %@Shell@'ModuleName'%.SendStr((unsigned char*)"disk is write protected!\r\n", io-&gt;stdErr);
    return ERR_FAILED;
  }
  fres = %'ModuleName'%.rename((char*)srcFileName, (char*)dstFileName);
  if(fres!=FR_OK) {
    FatFsFResultMsg((unsigned char*)"rename failed", fres, io);
    return ERR_FAILED;
  }
  return ERR_OK;
}

%endif %- RenameFile
%-BW_METHOD_END RenameFile
%-************************************************************************************************************
</code></pre>

<p>As far as I can tell, Processor Expert implements some kind of objects, named components, described by a template. This template can be instantiated for specific devices, like USART1, USART2, etc. People I respect consider that once the components are written, using them is quite convenient. The real challenge is to write these components, and this process can be done only with Processor Expert.</p>

<p>The syntax is quite complex, with commands similar to the C preprocessor (<code class="language-plaintext highlighter-rouge">%ifdef name</code>), but also with complex substitutions, like <code class="language-plaintext highlighter-rouge">%@Shell@'ModuleName'%.name(...)</code>.</p>

<p>The components can be found in the <code class="language-plaintext highlighter-rouge">C:\ProgramData\Processor Expert\PEXDRV_PE5_3</code> folder.</p>

<h3 id="ac6-system-workbench">AC6 System Workbench</h3>

<p>The STM32 System Workbench currently does not use templates.</p>

<h3 id="eclipse-cdt-template-wizard">Eclipse CDT template wizard</h3>

<p>The Eclipse CDT template mechanism uses several <em>processes</em>, mainly to copy files and to change the project configuration (add symbol definitions, folders, etc).</p>

<p>Like most other things in Eclipse, the definitions reside in a very verbose xml file. Preprocessing is basic, only macro substitutions. Conditional execution is limited to one level, and the implementation is not very fortunate.</p>

<h3 id="apache-freemarker">Apache FreeMarker</h3>

<p><a href="https://freemarker.org">FreeMarker</a> is another nice Apache Java project.</p>

<p>The templates are written in FTL (FreeMarket Template Language), which has an XML-like syntax, for example:</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">&lt;</span>#if animals.python.protected&gt;
  Pythons are protected animals!
<span class="err">&lt;</span>/#if&gt;
</code></pre></div></div>

<p>Substitutions are encoded as <code class="language-plaintext highlighter-rouge">${...}</code> and the data comes from a data-model which is a collection of Java objects.</p>

<p>The language has a large number of tags, but it cannot compete with a true scripting language.</p>

<p>Although it probably can handle any format, most examples in the FreeMarker documentation refer to generating HTML or XML output, which might be an indication of its intended audience.</p>

<h2 id="scripting-proposal">Scripting proposal</h2>

<p>It looks like using some kind of scripting language is inevitable. Defining a custom one, even inspired by an existing solution, is possible, but implementing it requires significant efforts.</p>

<p>With the omnipresent JavaScript, a simpler solution might be to implement the scripting part in JavaScript.</p>

<p>The DAVE idea to have the entire template as a script is interesting, but an even better option might be to generate this script.</p>

<p>So, the current proposal to be used by the XCDL preprocessor is to convert the entire template file into JavaScript, and to execute it.</p>

<h2 id="javascript-implementations">JavaScript implementations</h2>

<p>Executing JavaScript inside another program might be a problem, but mature JavaScript implementations are now available for most platforms and languages, for example:</p>

<ul>
  <li><a href="https://github.com/robertkrimen/otto">Go Otto</a></li>
  <li><a href="https://github.com/mozilla/rhino">Java Rhino</a></li>
</ul>

<h2 id="possible-syntax-solutions">Possible syntax solutions</h2>

<p>Assuming the tags will be encoded as comments, the simplest solution would be to prefix the lines with a specific comment:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">//@XCDL</code></li>
</ul>

<p>To simplify things even further, there should be no other non-spaces before this separator.</p>

<h2 id="javascript">JavaScript</h2>

<p>With the choice for JavaScript and this simple syntax, the process to convert the templates to JavaScript is relatively straightforward: process line by line, identify <code class="language-plaintext highlighter-rouge">//@XCDL</code>, pass the tags as-is, and encode all other source line in an output call.</p>

<p>For example:</p>

<pre><code class="language-txt">//@XCDL if (variable==="value") {
... C/C++ lines ...
//@XCDL }
</code></pre>
<p>translates into:</p>

<pre><code class="language-.js">if (variable==="value") {
o("... C/C++ lines ...\n");
}
</code></pre>

<p>where <code class="language-plaintext highlighter-rouge">o(str)</code> is a function that outputs the string to the destination file.</p>

<p>Substitutions are can be identified and processed by the JavaScript, or can be optimised by generating a JavaScript code that converts the values to strings and outputs them.</p>

<pre><code class="language-txt">#define VARIABLE ($(value+1))
</code></pre>

<p>can be translated to:</p>

<pre><code class="language-txt">o("#define VARIABLE (");o(String(value+1));o(")\n");
</code></pre>

<h2 id="examples">Examples</h2>

<p>With these conventions, the first sample would look like:</p>

<pre><code class="language-txt">//@XCDL if (defined('user')) {
hello ("$(user.name)!");
//@XCDL }
url = "$(url+'.html'))";
</code></pre>

<p>As expected, this is perfectly legal C syntax. The JavaScript code uses a function <code class="language-plaintext highlighter-rouge">defined()</code> that checks if an object is defined, and, if so, expands the <code class="language-plaintext highlighter-rouge">name</code> attribute of this object.</p>

<p>A more complex example would generate the <code class="language-plaintext highlighter-rouge">main.c</code>/<code class="language-plaintext highlighter-rouge">main.cpp</code> files in the STM32F4 template:</p>

<pre><code class="language-.cpp">//
// This file is part of the GNU ARM Eclipse distribution.
// Copyright (c) 2016 Liviu Ionescu.
//
// ----------------------------------------------------------------------------
#include &lt;stdio.h&gt;
#include "diag/trace.h"
//@XCDL   if (content==="blinky") {

//@XCDL     if (fileExtension==="c") {
#include "timer.h"
#include "blink_led.h"
//@XCDL     } else if (fileExtension==="cpp") {
#include "timer.h"
#include "blink_led.h"
//@XCDL     } // fileExtension
//@XCDL   } // content

// ----------------------------------------------------------------------------
//
//@XCDL   if (content==="blinky") {
//@XCDL     if (syscalls==="none") {
// Standalone $(shortChipFamily) led blink sample (trace via $(trace)).
// In debug configurations, demonstrate how to print a greeting message
// on the trace device. In release configurations the message is
// simply discarded.
//
// Then demonstrates how to blink a led with 1 Hz, using a
// continuous loop and SysTick delays.
//@XCDL     } else if (syscalls==="retarget") {
// $(shortChipFamily) led blink sample (trace via $(trace)).
// In debug configurations, demonstrate how to print a greeting message
// on the trace device. In release configurations the message is
// simply discarded.
//
// To demonstrate POSIX retargetting, reroute the STDOUT and STDERR to the
// trace device and display messages on both of them.
//
// Then demonstrates how to blink a led with 1 Hz, using a
// continuous loop and SysTick delays.
//
// On DEBUG, the uptime in seconds is also displayed on the trace device.
//@XCDL     } else if (syscalls==="semihosting") {
// Semihosting $(shortChipFamily) led blink sample (trace via $(trace)).
// In debug configurations, demonstrate how to print a greeting message
// on the trace device. In release configurations the message is
// simply discarded.
//
// To demonstrate semihosting, display a message on the standard output
// and another message on the standard error.
//
// Then demonstrates how to blink a led with 1 Hz, using a
// continuous loop and SysTick delays.
//
// On DEBUG, the uptime in seconds is also displayed on the trace device.
//@XCDL     } // syscalls
//@XCDL   } else if (content==="empty") {
//@XCDL     if (syscalls==="none") {
// Standalone $(shortChipFamily) empty sample (trace via $(trace)).
//@XCDL     } else if (syscalls==="retarget") {
// $(shortChipFamily) empty sample (trace via $(trace)).
//@XCDL     } else if (syscalls==="semihosting") {
// Semihosting $(shortChipFamily) empty sample (trace via $(trace)).
//@XCDL     } // syscalls
//@XCDL   } // content
//
// Trace support is enabled by adding the TRACE macro definition.
// By default the trace messages are forwarded to the $(trace) output,
// but can be rerouted to any device or completely suppressed, by
// changing the definitions required in system/src/diag/trace_impl.c
// (currently OS_USE_TRACE_ITM, OS_USE_TRACE_SEMIHOSTING_DEBUG/_STDOUT).
//
//@XCDL   if "$(content==="blinky") {
// The external clock frequency is specified as a preprocessor definition
// passed to the compiler via a command line option (see the 'C/C++ General' -&gt;
// 'Paths and Symbols' -&gt; the 'Symbols' tab, if you want to change it).
// The value selected during project creation was HSE_VALUE=$(hseValue).
//
// Note: The default clock settings take the user defined HSE_VALUE and try
// to reach the maximum possible system clock. For the default 8 MHz input
// the result is guaranteed, but for other values it might not be possible,
// so please adjust the PLL settings in system/src/cmsis/system_$(CMSIS_name).c
//
//@XCDL     if (fileExtension==="c") {
// ----- Timing definitions ---------------------------------------------------
// Keep the LED on for 2/3 of a second.
#define BLINK_1S_TICKS  (TIMER_FREQUENCY_HZ)
#define BLINK_ON_TICKS  (TIMER_FREQUENCY_HZ * 2 / 3)
#define BLINK_OFF_TICKS (TIMER_FREQUENCY_HZ - BLINK_ON_TICKS)
//@XCDL     } else if (fileExtension==="cpp") { */
// Definitions visible only within this translation unit.
//@XCDL // This hack is required to avoid confusing the formatter.
$("namespace")
  {
  // ----- Timing definitions -----------------------------------------------

  // Keep the LED on for 2/3 of a second.
  constexpr timer::ticks_t BLINK_1S_TICKS = timer::FREQUENCY_HZ;
  constexpr timer::ticks_t BLINK_ON_TICKS = timer::FREQUENCY_HZ * 2 / 3;
  constexpr timer::ticks_t BLINK_OFF_TICKS = timer::FREQUENCY_HZ - BLINK_ON_TICKS;
  }
//@XCDL     } // fileExtension
//@XCDL   } // content

// ----- main() ---------------------------------------------------------------
// Sample pragmas to cope with warnings. Please note the related line at
// the end of this function, used to pop the compiler diagnostics status.
#pragma GCC diagnostic push
#pragma GCC diagnostic ignored "-Wunused-parameter"
#pragma GCC diagnostic ignored "-Wmissing-declarations"
#pragma GCC diagnostic ignored "-Wreturn-type"

int
main (int argc, char* argv[])
{
//@XCDL   if (content==="blinky") {
//@XCDL     if (syscalls==="retarget") {
  // By customising __initialize_args() it is possible to pass arguments,
  // for example when running tests with semihosting you can pass various
  // options to the test.
  // trace_dump_args(argc, argv);
//@XCDL     } else if (syscalls==="semihosting") {
  // Show the program parameters (passed via semihosting).
  // Output is via the semihosting output channel.
  trace_dump_args (argc, argv);
//@XCDL     } // syscalls

  // Send a greeting to the trace device (skipped on Release).
  trace_puts ("Hello ARM World!");

//@XCDL     if (syscalls==="retarget") {
  // The standard output and the standard error should be forwarded to
  // the trace device. For this to work, a redirection in _write.c is
  // required.
  // Send a message to the standard output.
  puts ("Standard output message.");

  // Send a message to the standard error.
  fprintf (stderr, "Standard error message.\n");
//@XCDL     } else if (syscalls==="semihosting") {
  // Send a message to the standard output.
  puts ("Standard output message.");

  // Send a message to the standard error.
  fprintf (stderr, "Standard error message.\n");
//@XCDL     } // syscalls

  // At this stage the system clock should have already been configured
  // at high speed.
  trace_printf ("System clock: %u Hz\n", SystemCoreClock);

//@XCDL     if (fileExtension==="c") {
  timer_start ();

  blink_led_init ();

  uint32_t seconds = 0;

  // Infinite loop
  for (int i = 0;; i++)
  {
    blink_led_on ();
    timer_sleep (i == 0 ? BLINK_1S_TICKS : BLINK_ON_TICKS);

    blink_led_off ();
    timer_sleep (BLINK_OFF_TICKS);

    ++seconds;
    // Count seconds on the trace device.
    trace_printf ("Second %u\n", seconds);
  }
//@XCDL     } else if (fileExtension==="cpp") {
  timer tm;
  tm.start ();

  blink_led led;

  // Perform all necessary initialisations for the LED.
  led.powerUp ();

  uint32_t seconds = 0;

  // Infinite loop
  for (int i = 0;; i++)
  {
    led.turnOn ();
    timer_sleep (i == 0 ? BLINK_1S_TICKS : BLINK_ON_TICKS);

    led.turnOff ();
    tm.sleep (BLINK_OFF_TICKS);

    ++seconds;
    // Count seconds on the trace device.
    trace::printf ("Second %u\n", seconds);
  }
//@XCDL     } // fileExtension
  // Infinite loop, never return.
//@XCDL   } else if (content==="empty") {
  // At this stage the system clock should have already been configured
  // at high speed.
  // Infinite loop
  while (1)
    {
      // Add your code here.
    }
//@XCDL   } // content */
}

#pragma GCC diagnostic pop

// ----------------------------------------------------------------------------
</code></pre>


    <div class="tags">
        
    </div>

    


</div>

<hr class="shaded"/>

<footer>
            <div class="row">
                <div class="col-lg-12 footer">
               &copy;2024 Liviu Ionescu. All rights reserved. <br />
<span>Page last updated:</span> Dec 20, 2024<br/> Site last generated: Dec 20, 2024 <br />
                </div>
            </div>
</footer>


        </div>
    <!-- /.row -->
</div>
<!-- /.container -->
</div>
<!-- /#main -->
    </div>

</body>

<!-- the google_analytics_id gets auto inserted from the config file -->




<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-8WX9T80JEK"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-8WX9T80JEK');
</script>


</html>
